---
import Layout from "@/layouts/Layout.astro";
import InstrumentHistoryView from "@/components/features/instruments/InstrumentHistoryView";

export const prerender = false;

// Get Supabase client and check authentication
const supabase = Astro.locals.supabase;
const {
  data: { user },
  error,
} = await supabase.auth.getUser();

if (error || !user) {
  return Astro.redirect("/signin");
}

// Extract instrument ID from URL parameters
const { id } = Astro.params;

if (!id) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

// Get session for access token
const {
  data: { session },
} = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect("/signin");
}

// Pass session access token to the component for API calls
const accessToken = session.access_token;
---

<Layout title="Instrument History">
  <InstrumentHistoryView client:visible instrumentId={id} accessToken={accessToken} />
</Layout>
